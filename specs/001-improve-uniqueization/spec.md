# Feature Specification: Улучшение методов уникализации изображений

**Feature Branch**: `001-improve-uniqueization`
**Created**: 2025-11-28
**Status**: Draft
**Input**: User description: "нам нужно улучшить бот уникализации продумать другие варианты. Нужно сохранить качество фото"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - Выбор метода уникализации (Priority: P1)

Пользователь отправляет изображение в бот и хочет выбрать способ уникализации, чтобы получить оптимальный результат для своих целей.

**Why this priority**: Это основная функциональность, которая даёт пользователю контроль над процессом и позволяет адаптировать уникализацию под конкретные задачи.

**Independent Test**: Можно полностью протестировать отправкой изображения и выбором метода — пользователь получает уникализированное изображение выбранным способом.

**Acceptance Scenarios**:

1. **Given** пользователь отправил изображение, **When** бот предлагает варианты методов уникализации, **Then** пользователь видит список доступных методов с кратким описанием
2. **Given** пользователь выбрал метод уникализации, **When** бот обрабатывает изображение, **Then** изображение обрабатывается выбранным методом и возвращается пользователю
3. **Given** пользователь не выбрал метод в течение 30 секунд, **When** таймаут истекает, **Then** применяется метод по умолчанию

---

### User Story 2 - Сохранение высокого качества изображения (Priority: P1)

Пользователь хочет, чтобы уникализированное изображение визуально не отличалось от оригинала и сохраняло исходное качество.

**Why this priority**: Качество изображения критически важно — потеря качества делает бот бесполезным для пользователей.

**Independent Test**: Сравнение оригинала и результата визуально и по метрикам качества (SSIM, PSNR).

**Acceptance Scenarios**:

1. **Given** пользователь отправил изображение высокого качества, **When** бот уникализирует его любым методом, **Then** разница между оригиналом и результатом не заметна невооружённым глазом
2. **Given** изображение уникализировано, **When** пользователь сравнивает размеры файлов, **Then** размер результата не превышает размер оригинала более чем на 20%
3. **Given** изображение в формате PNG, **When** бот обрабатывает его, **Then** прозрачность сохраняется (если была)

---

### User Story 3 - Генерация нескольких уникальных копий (Priority: P1)

Пользователь хочет получить несколько уникальных версий одного изображения за один запрос.

**Why this priority**: Ключевая функциональность для пользователей, которым нужно много уникальных копий одного изображения (маркетинг, соцсети).

**Independent Test**: Отправка одного изображения с выбором количества копий — получение архива с указанным числом уникальных версий.

**Acceptance Scenarios**:

1. **Given** пользователь отправил изображение, **When** бот предлагает выбрать количество копий, **Then** пользователь видит кнопки с вариантами (1, 5, 10, 20, произвольное)
2. **Given** пользователь выбрал количество копий > 1, **When** бот обрабатывает изображение, **Then** результат отправляется как ZIP-архив с указанным числом уникальных файлов
3. **Given** пользователь выбрал 1 копию, **When** бот обрабатывает изображение, **Then** результат отправляется как одиночный файл (без архива)
4. **Given** пользователь ввёл произвольное число, **When** число в допустимом диапазоне (1-100), **Then** бот генерирует указанное количество копий

---

### User Story 4 - Пакетная обработка изображений (Priority: P2)

Пользователь хочет отправить несколько изображений за раз и получить их все уникализированными.

**Why this priority**: Удобство для пользователей с большим объёмом изображений, но не критично для базовой функциональности.

**Independent Test**: Отправка нескольких изображений одним сообщением или серией — все обрабатываются и возвращаются.

**Acceptance Scenarios**:

1. **Given** пользователь отправляет альбом из нескольких изображений, **When** бот получает их, **Then** каждое изображение обрабатывается и возвращается отдельным файлом
2. **Given** в альбоме более 10 изображений, **When** бот обрабатывает их, **Then** пользователь видит прогресс обработки
3. **Given** одно изображение из пакета не удалось обработать, **When** возникает ошибка, **Then** остальные изображения обрабатываются, а для проблемного показывается сообщение об ошибке

---

### User Story 5 - Предпросмотр результата (Priority: P3)

Пользователь хочет увидеть превью результата перед получением полноразмерного файла.

**Why this priority**: Улучшает пользовательский опыт, но не является обязательной функцией.

**Independent Test**: Пользователь видит сжатое превью и может подтвердить или отменить обработку.

**Acceptance Scenarios**:

1. **Given** пользователь отправил изображение и включил режим предпросмотра, **When** бот обрабатывает изображение, **Then** сначала показывается уменьшенная версия результата
2. **Given** пользователь видит превью, **When** пользователь подтверждает, **Then** отправляется полноразмерный файл

---

### Edge Cases

- Что происходит при отправке повреждённого или неподдерживаемого файла? — Пользователь получает понятное сообщение об ошибке
- Как система обрабатывает очень большие изображения (>20 МБ)? — Изображение обрабатывается с соответствующим уведомлением о времени обработки
- Что если пользователь отправляет уже уникализированное изображение? — Бот обрабатывает его повторно без предупреждений
- Как обрабатываются анимированные изображения (GIF)? — GIF не поддерживается, пользователь получает сообщение об этом
- Что происходит при потере соединения во время обработки? — При восстановлении соединения пользователь может повторить запрос

## Requirements *(mandatory)*

### Functional Requirements

#### Методы уникализации

- **FR-001**: Система ДОЛЖНА предоставлять следующие методы уникализации как отдельные опции:
  - Только метаданные (замена EXIF/IPTC/XMP)
  - Микро-изменения (субпиксельный сдвиг, микро-коррекция яркости/цвета)
  - LSB-модификация (изменение младших битов пикселей)
  - Комбинированный (все методы вместе)
- **FR-002**: Система ДОЛЖНА позволять пользователю выбрать метод уникализации после отправки изображения
- **FR-003**: Система ДОЛЖНА применять комбинированный метод по умолчанию, если пользователь не сделал выбор
- **FR-004**: Каждый метод уникализации ДОЛЖЕН изменять бинарный хеш файла (MD5, SHA-256)
- **FR-005**: Система ДОЛЖНА сохранять исходный формат изображения (JPEG остаётся JPEG, PNG остаётся PNG)

#### Уникализация метаданных

- **FR-016**: Система ДОЛЖНА уникализировать метаданные изображения (EXIF, IPTC, XMP)
- **FR-017**: Система ДОЛЖНА генерировать уникальные значения для полей метаданных при каждой обработке
- **FR-018**: Система ДОЛЖНА полностью удалять все оригинальные метаданные и заменять их на новые случайные значения

#### Качество изображения

- **FR-006**: Система ДОЛЖНА сохранять визуальное качество изображения (SSIM >= 0.99 по сравнению с оригиналом)
- **FR-007**: Система ДОЛЖНА сохранять исходное разрешение изображения (допустимая потеря: не более 3 пикселей с каждой стороны)
- **FR-008**: Система ДОЛЖНА сохранять цветовой профиль изображения
- **FR-009**: Система ДОЛЖНА сохранять прозрачность для PNG изображений

#### Интерфейс пользователя

- **FR-010**: Система ДОЛЖНА отображать список доступных методов в виде кнопок или меню
- **FR-011**: Система ДОЛЖНА показывать статус обработки для изображений, обрабатываемых более 3 секунд
- **FR-012**: Система ДОЛЖНА возвращать обработанное изображение как документ с сохранением оригинального имени файла (с добавлением суффикса)

#### Генерация нескольких копий

- **FR-019**: Система ДОЛЖНА позволять пользователю выбрать количество уникальных копий для генерации (1, 5, 10, 20 или произвольное число)
- **FR-020**: Система ДОЛЖНА поддерживать генерацию от 1 до 100 уникальных копий одного изображения
- **FR-021**: Каждая сгенерированная копия ДОЛЖНА иметь уникальный хеш, отличный от оригинала и других копий
- **FR-022**: При выборе количества > 1 система ДОЛЖНА отправлять результат в виде ZIP-архива
- **FR-023**: При выборе количества = 1 система ДОЛЖНА отправлять результат как одиночный файл
- **FR-024**: Имена файлов в архиве ДОЛЖНЫ содержать порядковый номер (image_1.jpg, image_2.jpg, ...)
- **FR-025**: Система ДОЛЖНА показывать прогресс генерации при количестве копий > 10

#### Пакетная обработка

- **FR-013**: Система ДОЛЖНА поддерживать обработку нескольких изображений, отправленных одним сообщением
- **FR-014**: Система ДОЛЖНА ограничивать количество изображений в одном пакете (максимум 10 штук)
- **FR-015**: Система ДОЛЖНА обрабатывать каждое изображение в пакете независимо

### Key Entities

- **Изображение**: Файл в формате JPEG или PNG, отправляемый пользователем для обработки
- **Метод уникализации**: Алгоритм преобразования изображения для изменения его бинарного представления
- **Сессия обработки**: Временный контекст, хранящий выбранные настройки пользователя для текущего изображения

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 100% обработанных изображений имеют уникальный хеш, отличный от оригинала
- **SC-002**: Визуальное качество уникализированных изображений не отличается от оригинала для 95% пользователей (на основе A/B тестирования или опроса)
- **SC-003**: Среднее время обработки одного изображения не превышает 5 секунд для изображений до 10 МБ
- **SC-004**: 90% пользователей успешно получают результат с первой попытки (без повторных отправок)
- **SC-005**: Размер уникализированного файла не превышает размер оригинала более чем на 20%
- **SC-006**: Метрика качества SSIM >= 0.99 для всех обработанных изображений

## Clarifications

### Session 2025-11-28

- Q: Нужна ли уникализация метаданных? → A: Да, метаданные должны уникализироваться
- Q: Как обрабатывать оригинальные метаданные? → A: Полностью удалить и заменить на новые случайные значения
- Q: Какие методы уникализации пикселей? → A: Все методы (метаданные, микро-изменения, LSB-шум) как отдельные опции
- Q: Метод по умолчанию? → A: Комбинированный (максимальная уникализация)
- Q: Генерация нескольких копий? → A: Да, выбор количества (1-100), при >1 отдавать ZIP-архивом

## Assumptions

- Пользователи преимущественно отправляют изображения в форматах JPEG и PNG
- Основная цель уникализации — изменение хеша файла при сохранении визуального качества
- Бот работает через Telegram API, который имеет ограничения на размер файлов (20 МБ для ботов)
- Пользователи понимают базовую концепцию уникализации и не требуют детального объяснения каждого метода
- Метод по умолчанию должен обеспечивать баланс между степенью уникализации и сохранением качества

## Out of Scope

- Уникализация видео файлов
- Уникализация анимированных GIF
- Автоматическое улучшение качества изображений (ресайз, шумоподавление)
- Добавление водяных знаков или текста на изображение
- Интеграция с другими мессенджерами кроме Telegram
